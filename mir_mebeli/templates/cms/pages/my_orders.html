{% load shop pytils_numeral thumbnail %}

{# текущие заказы #}
{% for order in request.user.buyer.order_set.get_unfinished_orders_list %}
    <div id="order_{{ order.pk }}" class="cart-order{% if order.is_unpaid %} order-unpaid{% else %} order-waiting{% endif %}">

        <div class="order-title">
            Заказ №{{ order.pk }} от {{ order.create_date|date:"d.m.Y" }}

            {% if order.is_unpaid %}
                <div class="del">
                    <a id="order_cancel_{{ order.pk }}" class="order-cancel" href="{% url shop-order-cancel order.pk %}" title="Отмена заказа № {{ order.pk }}">Отменить заказ</a>
                </div>
            {% endif %}
        </div>

        <div class="tbl-header">
            <div class="l w540">Состав заказа</div>
            <div class="l w110">Количество</div>
            <div class="l w85">Цена</div>
            <div class="r w400">Параметры заказа</div>
        </div>

        <div class="l w750">
            {% for item in order.items.all %}
                {% with item.good as good %}
                    <div class="clear order-good no-borders{% cycle ' odd' ' even' %}">
                        <div class="image l">
                            {% thumbnail good.image "100x70" padding=True as img %}
                                <img src="{{ img.url }}" width="100" height="70" title="{{ good.get_name }}" />
                            {% empty %}
                                <img src="{{ MEDIA_URL }}images/noimage.jpg" width="100" height="70" title="{{ good.get_name }}" />
                            {% endthumbnail %}
                        </div>
                        <div class="l w400 mr20">
                            <div class="title">{{ good.get_name }}</div>
                            {% comment %}<div class="desc">
                            </div>{% endcomment %}
                        </div>
                            <div class="l w110 price"><span class="pprice2">{{ item.count }}</span></div>
    {#                        <div class="total-price"><span class="pprice">{{ item.sum|price }} р.</span></div>#}
                            <div class="l w85 price"><span class="pprice2">{{ item.price|price }} р.</span></div>
                    </div>
                {% endwith %}
            {% endfor %}
        </div>

        <div class="order-param">
            <div>Продавец: ООО "Торговый дом", 183031, Мурманск, Свердлова 29/2</div>

            <div style="margin-top: 10px;">Покупатель: {{ order.get_full_fio|default:"нет данных" }}</div>
            <div>Адрес для доставки: {{ order.city }}, {{ order.address }}</div>
            <div>Телефон покупателя: {{ order.phone }}</div>

            <div style="margin-top: 10px;">
                Оплата товаров:<br />
                {{ order.get_payment_method }} &ndash;
                <span class="pprice2">{{ order.sum|price }} р.</span>
            </div>
        </div>

        {# если оплата карточкой #}
        {% if order.is_card_payment %}
            {% if order.is_await_approval_status %}
                <div class='l bottom-order-status bottom-approval'>
                    <h2>{{ order.get_status_display|capfirst }}.</h2>
                    <p>Заказ обрабатывается.</p>
                </div>
            {% endif %}

            {% if order.is_card_await_payment_status %}
                <div class='l bottom-order-status bottom-unpaid'>
                    <h2>{{ order.get_status_display|capfirst }}.</h2>
                    <p>Нажмите "Перейти к оплате" для совершения безопасного платежа банковской картой на сайте банка "Промсвязьбанк".<br />К оплате принимаются карты Visa и Mastercard любых банков.</p>
                </div>
            {% endif %}

            {% if order.is_paid_await_completing_status %}
                <div class='l bottom-order-status bottom-waiting'>
                    <h2>{{ order.get_status_display|capfirst }}.</h2>
                    <p>Ваш заказ принят, оплачен и ожидает комплектации. При возникновении вопросов, пожалуйста, позвоните по номеру (8152) 200-730.</p>
                </div>
            {% endif %}

            {% if order.is_completing_status %}
                <div class='l bottom-order-status bottom-waiting'>
                    <h2>{{ order.get_status_display|capfirst }}.</h2>
                    <p>Ваш заказ подтверждён, оплата получена и в настоящее время комплектуется. Наш менеджер свяжется с Вами, чтобы согласовать время доставки.</p>
                </div>
            {% endif %}

            {% if order.is_delivering_status %}
                <div class='l bottom-order-status bottom-waiting'>
                    <h2>{{ order.get_status_display|capfirst }}.</h2>
                    <p>Ваш заказ передан в транспортную компанию и в ближайшее время будет доставлен. Наш менеджер свяжется с Вами, чтобы сообщить точное время доставки.</p>
                </div>
            {% endif %}

            {# кнопка перехода к оплате #}
            {% if order.is_card_await_payment_status %}
                <div class=" buy_btn_order">
                    {%  with order.get_ya_pay_form as pay_form %}
                        <form action="{{ pay_form.payment_url }}" method="post">
                            {% for field in pay_form %}
                                {{ field }}
                            {% endfor %}
                            <div class="buy_btn_order">
                            <button type="submit" role="button" name="submit" class="button-end-order">
                                <h2>Перейти к оплате</h2>
                                <p>К оплате принимаются карты Visa, Mastercard любых банков</p>
                            </button>
                            </div>
                        </form>
                    {% endwith %}
                </div>
            {% endif %}
        {% endif %}

        {# если оплата наличкой #}
        {% if order.is_cash_payment %}
            {% if order.is_new_status %}
                <div class='l bottom-order-status bottom-unpaid'>
                    <h2>{{ order.get_status_display|capfirst }}.</h2>
                    <p>Ваш заказ принят и ожидает обработки нашими менеджерами. В ближайшее время мы свяжемся с Вами, чтобы согласовать способы доставки и оплаты товаров.</p>
                </div>
            {% endif %}

            {% if order.is_await_payment_status %}
                <div class='l bottom-order-status bottom-unpaid'>
                    <h2>{{ order.get_status_display|capfirst }}.</h2>
                    <p>Ваш заказ подтверждён и Вы можете оплатить его в любом нашем магазине. При возникновении вопросов, пожалуйста, позвоните по номеру (8152) 200-730.</p>
                </div>
            {% endif %}

            {% if order.is_completing_status %}
                <div class='l bottom-order-status bottom-waiting'>
                    <h2>{{ order.get_status_display|capfirst }}.</h2>
                    <p>Ваш заказ оплачен, подтверждён, и в настоящее время комплектуется. Наш менеджер свяжется с Вами, чтобы согласовать время доставки.</p>
                </div>
            {% endif %}

            {% if order.is_delivering_status %}
                <div class='l bottom-order-status bottom-waiting'>
                    <h2>{{ order.get_status_display|capfirst }}.</h2>
                    <p>Ваш заказ передан в транспортную компанию и в ближайшее время будет доставлен. Наш менеджер свяжется с Вами, чтобы сообщить точное время доставки.</p>
                </div>
            {% endif %}
        {% endif %}
    </div>

    <div class="clear"></div>
{% endfor %}

{# форма отмены заказа #}
{% with order_cancel_form as form %}
    <form id="order_cancel_form" class="ajax-form dialog-form" action="" method="post" title="Отмена заказа">
        {% csrf_token %}

        <div class="form-errors">{{ form.non_field_errors }}</div>

        {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

        <div class="header-text">Пожалуйста, укажите причину отмены заказа:</div>

        {% with form.reason as field %}
            <div id="{{ field.name }}" class="field clear">
                {{ field }}
                <div class="errors">{{ field.errors }}</div>
            </div>
        {% endwith %}

        <div class="buttons">
            <input type="button" name="_cancel" value="Оставить заказ">
            <input type="submit" name="submit" value="Удалить этот заказ" class="button-as-link">
        </div>
    </form>
{% endwith %}
